<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOT ì˜ˆì¸¡ê¸° - End-of-Turn Predictor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .result-section {
            margin-top: 20px;
        }

        .eot-probability {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .eot-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .eot-value.high {
            color: #e74c3c;
        }

        .eot-value.medium {
            color: #f39c12;
        }

        .eot-value.low {
            color: #27ae60;
        }

        .eot-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .eot-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            transition: width 0.5s ease;
        }

        .assessment {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .tokens-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .tokens-table th,
        .tokens-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .tokens-table th {
            background: #f8f9fa;
            color: #667eea;
            font-weight: bold;
        }

        .tokens-table tr:hover {
            background: #f8f9fa;
        }

        .eot-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .eot-badge.eot {
            background: #e74c3c;
            color: white;
        }

        .eot-badge.normal {
            background: #95a5a6;
            color: white;
        }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #3498db;
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border: 2px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .batch-results {
            margin-top: 20px;
        }

        .batch-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .batch-item .text {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .batch-item .stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .context-turn {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .context-turn input {
            flex: 1;
        }

        .context-turn button {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .add-context {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ EOT ì˜ˆì¸¡ê¸°</h1>
            <p>í•œêµ­ì–´ ì±„íŒ… ë°œí™” ì¢…ë£Œ í™•ë¥ ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>ì˜ˆì¸¡</h2>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('single')">ë‹¨ì¼ ì˜ˆì¸¡</button>
                    <button class="tab" onclick="switchTab('batch')">ë°°ì¹˜ ì˜ˆì¸¡</button>
                    <button class="tab" onclick="switchTab('context')">ì»¨í…ìŠ¤íŠ¸ ì˜ˆì¸¡</button>
                </div>

                <!-- ë‹¨ì¼ ì˜ˆì¸¡ -->
                <div id="single-tab" class="tab-content active">
                    <div class="input-group">
                        <label for="single-text">ì…ë ¥ í…ìŠ¤íŠ¸:</label>
                        <textarea id="single-text" placeholder="ì˜ˆ: ê·¸ë˜ ì•Œì•˜ì–´"></textarea>
                    </div>
                    <button onclick="predictSingle()">ì˜ˆì¸¡ ì‹¤í–‰</button>
                </div>

                <!-- ë°°ì¹˜ ì˜ˆì¸¡ -->
                <div id="batch-tab" class="tab-content">
                    <div class="input-group">
                        <label for="batch-text">ì…ë ¥ í…ìŠ¤íŠ¸ (í•œ ì¤„ì— í•˜ë‚˜ì”©):</label>
                        <textarea id="batch-text" placeholder="ì•ˆë…•í•˜ì„¸ìš”&#10;ê·¸ë˜ ì•Œì•˜ì–´&#10;ì˜¤ëŠ˜ ë­ ë¨¹ì—ˆì–´"></textarea>
                    </div>
                    <button onclick="predictBatch()">ë°°ì¹˜ ì˜ˆì¸¡ ì‹¤í–‰</button>
                </div>

                <!-- ì»¨í…ìŠ¤íŠ¸ ì˜ˆì¸¡ -->
                <div id="context-tab" class="tab-content">
                    <div class="input-group">
                        <label>ëŒ€í™” ì»¨í…ìŠ¤íŠ¸:</label>
                        <div id="context-inputs">
                            <div class="context-turn">
                                <input type="text" placeholder="í„´ 1" value="ì•ˆë…•í•˜ì„¸ìš”">
                            </div>
                            <div class="context-turn">
                                <input type="text" placeholder="í„´ 2" value="ë„¤ ì•ˆë…•í•˜ì„¸ìš”">
                            </div>
                        </div>
                        <button class="add-context" onclick="addContextTurn()">+ í„´ ì¶”ê°€</button>
                    </div>
                    <button onclick="predictContext()">ì»¨í…ìŠ¤íŠ¸ ì˜ˆì¸¡ ì‹¤í–‰</button>
                </div>

                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>ì˜ˆì¸¡ ì¤‘...</p>
                </div>

                <!-- ê²°ê³¼ í‘œì‹œ -->
                <div id="result" class="result-section"></div>
            </div>

            <div class="card">
                <h2>ì„¤ì •</h2>
                <div class="settings-grid">
                    <div class="input-group">
                        <label for="model">ëª¨ë¸:</label>
                        <select id="model">
                            <option value="polyglot" selected>Polyglot-Ko</option>
                            <option value="kogpt2">KoGPT2</option>
                            <option value="kanana-nano-2.1b-base">Kanana Nano</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="run-mode">ì‹¤í–‰ ëª¨ë“œ:</label>
                        <select id="run-mode">
                            <option value="">ì„œë²„ ê¸°ë³¸ê°’</option>
                            <option value="auto">Auto</option>
                            <option value="cpu" selected>CPU</option>
                            <option value="nvidia-gpu">NVIDIA GPU</option>
                            <option value="amd-gpu">AMD GPU</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="top-k">Top-K:</label>
                        <input type="number" id="top-k" value="10" min="1" max="20">
                    </div>

                    <div class="input-group">
                        <label for="temperature">Temperature:</label>
                        <input type="number" id="temperature" value="0.5" min="0.1" max="2.0" step="0.1">
                    </div>

                    <div class="input-group">
                        <label for="timeout">Timeout (ì´ˆ):</label>
                        <input type="number" id="timeout" value="60" min="0" max="300">
                    </div>

                    <div class="input-group">
                        <label for="api-url">API URL:</label>
                        <input type="text" id="api-url" value="http://localhost:8177">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'single';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function getSettings() {
            const runMode = document.getElementById('run-mode').value;
            return {
                model: document.getElementById('model').value,
                run_mode: runMode || undefined,
                top_k: parseInt(document.getElementById('top-k').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                timeout: parseInt(document.getElementById('timeout').value)
            };
        }

        function getApiUrl() {
            return document.getElementById('api-url').value;
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').innerHTML = '';
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function showError(message) {
            hideLoading();
            document.getElementById('result').innerHTML = `
                <div class="error">
                    <strong>ì˜¤ë¥˜:</strong> ${message}
                </div>
            `;
        }

        function displaySingleResult(data) {
            hideLoading();
            const eotProb = data.eot_probability;
            const assessment = data.eot_assessment;

            let assessmentText = '';
            let assessmentClass = '';

            if (assessment === 'high') {
                assessmentText = 'ë†’ì€ í™•ë¥ ë¡œ ë°œí™”ê°€ ëë‚¨';
                assessmentClass = 'high';
            } else if (assessment === 'medium') {
                assessmentText = 'ë°œí™”ê°€ ëë‚  ìˆ˜ë„ ìˆìŒ';
                assessmentClass = 'medium';
            } else {
                assessmentText = 'ì•„ì§ ë°œí™”ê°€ ëë‚˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±ì´ í¼';
                assessmentClass = 'low';
            }

            let tokensHtml = '';
            data.predictions.forEach((pred, idx) => {
                const eotBadge = pred.is_eot ?
                    '<span class="eot-badge eot">EOT</span>' :
                    '<span class="eot-badge normal">ì¼ë°˜</span>';

                tokensHtml += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><code>${escapeHtml(pred.token)}</code></td>
                        <td>${(pred.probability * 100).toFixed(2)}%</td>
                        <td>${eotBadge}</td>
                        <td><span class="type-badge">${pred.type}</span></td>
                    </tr>
                `;
            });

            document.getElementById('result').innerHTML = `
                <div class="eot-probability">
                    <div class="eot-value ${assessmentClass}">${(eotProb * 100).toFixed(1)}%</div>
                    <div class="eot-bar">
                        <div class="eot-bar-fill" style="width: ${eotProb * 100}%"></div>
                    </div>
                    <div class="assessment">${assessmentText}</div>
                </div>

                <h3>ì˜ˆì¸¡ í† í° ìƒì„¸</h3>
                <table class="tokens-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>í† í°</th>
                            <th>í™•ë¥ </th>
                            <th>EOT</th>
                            <th>íƒ€ì…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tokensHtml}
                    </tbody>
                </table>

                <p style="margin-top: 15px; color: #666;">
                    <small>ì†Œìš” ì‹œê°„: ${data.elapsed_time}ì´ˆ | ëª¨ë¸: ${data.model}</small>
                </p>
            `;
        }

        function displayBatchResults(data) {
            hideLoading();

            let resultsHtml = '<h3>ë°°ì¹˜ ì˜ˆì¸¡ ê²°ê³¼</h3>';
            resultsHtml += `<p>ì „ì²´: ${data.total_count}ê°œ | ì„±ê³µ: ${data.success_count}ê°œ | ì‹¤íŒ¨: ${data.failure_count}ê°œ</p>`;
            resultsHtml += '<div class="batch-results">';

            data.results.forEach((result, idx) => {
                if (result.success) {
                    const eotProb = result.eot_probability;
                    const assessment = result.eot_assessment;
                    let emoji = assessment === 'high' ? 'ğŸ”´' : assessment === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';

                    resultsHtml += `
                        <div class="batch-item">
                            <div class="text">${emoji} ${escapeHtml(result.text)}</div>
                            <div class="stats">
                                <span>EOT: <strong>${(eotProb * 100).toFixed(1)}%</strong></span>
                                <span>í‰ê°€: <strong>${assessment}</strong></span>
                                <span>ìƒìœ„ í† í°: <code>${escapeHtml(result.top_prediction)}</code></span>
                                <span>${result.elapsed_time}ì´ˆ</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsHtml += `
                        <div class="batch-item" style="border-left-color: #e74c3c;">
                            <div class="text">âŒ ${escapeHtml(result.text)}</div>
                            <div class="error" style="margin-top: 10px;">ì˜¤ë¥˜: ${result.error}</div>
                        </div>
                    `;
                }
            });

            resultsHtml += '</div>';
            resultsHtml += `<p style="margin-top: 15px; color: #666;"><small>ì´ ì†Œìš” ì‹œê°„: ${data.total_elapsed_time}ì´ˆ</small></p>`;

            document.getElementById('result').innerHTML = resultsHtml;
        }

        function displayContextResult(data) {
            hideLoading();
            const eotProb = data.eot_probability;
            const assessment = data.eot_assessment;

            let assessmentClass = assessment === 'high' ? 'high' : assessment === 'medium' ? 'medium' : 'low';

            let predsHtml = '';
            data.predictions.forEach((pred, idx) => {
                const eotBadge = pred.is_eot ?
                    '<span class="eot-badge eot">EOT</span>' :
                    '<span class="eot-badge normal">ì¼ë°˜</span>';

                predsHtml += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><code>${escapeHtml(pred.token)}</code></td>
                        <td>${(pred.probability * 100).toFixed(2)}%</td>
                        <td>${eotBadge}</td>
                    </tr>
                `;
            });

            document.getElementById('result').innerHTML = `
                <div class="eot-probability">
                    <div class="eot-value ${assessmentClass}">${(eotProb * 100).toFixed(1)}%</div>
                    <div class="eot-bar">
                        <div class="eot-bar-fill" style="width: ${eotProb * 100}%"></div>
                    </div>
                    <div class="assessment">${data.recommendation}</div>
                </div>

                <p style="margin-top: 15px;">ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´: ${data.context_length}í„´ (${data.combined_length}ì)</p>

                <h3>ìƒìœ„ ì˜ˆì¸¡ í† í°</h3>
                <table class="tokens-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>í† í°</th>
                            <th>í™•ë¥ </th>
                            <th>EOT</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${predsHtml}
                    </tbody>
                </table>

                <p style="margin-top: 15px; color: #666;">
                    <small>ì†Œìš” ì‹œê°„: ${data.elapsed_time}ì´ˆ | ëª¨ë¸: ${data.model}</small>
                </p>
            `;
        }

        async function predictSingle() {
            const text = document.getElementById('single-text').value.trim();

            if (!text) {
                showError('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${getApiUrl()}/predict/eot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        ...getSettings()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displaySingleResult(result.data);
                } else {
                    showError(result.error.message);
                }
            } catch (error) {
                showError(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function predictBatch() {
            const text = document.getElementById('batch-text').value.trim();

            if (!text) {
                showError('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const texts = text.split('\n').filter(t => t.trim());

            if (texts.length === 0) {
                showError('ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${getApiUrl()}/predict/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        texts: texts,
                        ...getSettings()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayBatchResults(result.data);
                } else {
                    showError(result.error.message);
                }
            } catch (error) {
                showError(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function predictContext() {
            const contextInputs = document.querySelectorAll('#context-inputs input');
            const context = Array.from(contextInputs)
                .map(input => input.value.trim())
                .filter(text => text);

            if (context.length === 0) {
                showError('ì»¨í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${getApiUrl()}/predict/context`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        context: context,
                        ...getSettings()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayContextResult(result.data);
                } else {
                    showError(result.error.message);
                }
            } catch (error) {
                showError(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function addContextTurn() {
            const container = document.getElementById('context-inputs');
            const turnNum = container.children.length + 1;

            const turnDiv = document.createElement('div');
            turnDiv.className = 'context-turn';
            turnDiv.innerHTML = `
                <input type="text" placeholder="í„´ ${turnNum}">
                <button onclick="removeContextTurn(this)">ì‚­ì œ</button>
            `;

            container.appendChild(turnDiv);
        }

        function removeContextTurn(button) {
            const container = document.getElementById('context-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        async function testConnection() {
            showLoading();

            try {
                const response = await fetch(`${getApiUrl()}/health`);
                const result = await response.json();

                hideLoading();

                if (result.status === 'healthy') {
                    document.getElementById('result').innerHTML = `
                        <div class="success">
                            <strong>âœ… ì—°ê²° ì„±ê³µ!</strong><br>
                            API ë²„ì „: ${result.version}<br>
                            ëª¨ë¸ ë¡œë“œë¨: ${result.model_loaded ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
                        </div>
                    `;
                } else {
                    showError(`ì„œë²„ ìƒíƒœ: ${result.status}`);
                }
            } catch (error) {
                showError(`ì—°ê²° ì‹¤íŒ¨: ${error.message}. API ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸
        window.addEventListener('load', () => {
            console.log('EOT ì˜ˆì¸¡ê¸° í”„ë¡ íŠ¸ì—”ë“œ ë¡œë“œë¨');
        });
    </script>
</body>
</html>
